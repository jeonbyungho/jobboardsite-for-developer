<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EmployerMapper">

<resultMap type="Employer" id="employerResult">
	<id column="empl_id" property="id"/>
	<result column="business_registration_number" property="businessRegistrationNumber"/>
	<result column="company_name"	property="companyName"/>
	<result column="founding_date"	property="foundingDate" typeHandler="org.apache.ibatis.type.LocalDateTypeHandler"/>
	<association property="member" javaType="Member">
		<id column="mb_id" property="id"/>
		<result column="username" 	property="username"/>
		<result column="password"	property="password"/>
		<result column="email"		property="email"/>
		<result column="created_at"	property="createdAt" typeHandler="org.apache.ibatis.type.LocalDateTimeTypeHandler"/>
	</association>
</resultMap>

<!-- 유저 아이디 조회 -->
<select id="findByUsername" parameterType="String" resultMap="employerResult">
	SELECT 
		e.empl_id  
	,	e.business_registration_number  
	,	e.company_name  
	,	e.founding_date  
	,	m.mb_id  
	,	m.username  
	,	m.password  
	,	m.email  
	,	m.created_at  
	FROM employer e 
		INNER JOIN members m ON e.mb_id = m.mb_id 
	WHERE m.username = #{username}
</select>

<!-- 회원 인증 (로그인) -->
<select id="signIn" parameterType="map" resultMap="employerResult">
	SELECT 
		e.empl_id  
	,	e.business_registration_number  
	,	e.company_name  
	,	e.founding_date  
	,	m.mb_id  
	,	m.username  
	,	m.password  
	,	m.email  
	,	m.created_at  
	FROM employer e 
		INNER JOIN members m ON e.mb_id = m.mb_id 
	WHERE m.username = #{username} AND m.password = #{password}
</select>

<!-- 회원 가입 -->
<insert id="signUp" parameterType="Employer">
	<selectKey keyProperty="mb_id" resultType="_int" order="BEFORE">
		SELECT member_seq.nextval FROM dual
	</selectKey>
	<selectKey keyProperty="empl_id" resultType="_int" order="BEFORE">
		SELECT employer_seq.nextval FROM dual
	</selectKey>
	
	BEGIN
	INSERT INTO MEMBERS m (
		m.MB_ID, m.USERNAME, m.PASSWORD, m.EMAIL
	) VALUES (
		#{mb_id},
		#{member.username}, #{member.password},
		#{member.email}
	);
	
	INSERT INTO EMPLOYER e (
		e.EMPL_ID, e.MB_ID, e.BUSINESS_REGISTRATION_NUMBER,e.COMPANY_NAME
	) VALUES (
		#{empl_id}, #{mb_id},
		#{businessRegistrationNumber},
		#{companyName},
		#{foundingDate}
	);
	END;
</insert>

</mapper>